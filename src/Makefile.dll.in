#################################
# $Id$
# Author:  Denis Vakatov (vakatov@ncbi.nlm.nih.gov)
#################################
# This can be used to build/install/clean
# a single shared(DLL) library [LIB] made of object files [LIBOBJ] and [LOBJ]
# where [LIBOBJ].o will be automagically compiled from [LIBOBJ].cpp or
# [LIBOBJ].c, and [LOBJ].o must be already compiled by this time.
# The following libs will be used to resolve external referencies:
#   [DLL_LIB]  -- libs located in the NCBI C++ "lib/" dir;
#   [DLL_LIBS] -- 3rd-party libs
#
################
## Example of usage:
#
# srcdir = @srcdir@
# include @builddir@/Makefile.mk
#
# LIB      = p1
# LIBOBJ   = p1_src1 p1_src2
# LOBJ     = p1_myobj
#
# DLL_LIB  = xncbi
# DLL_LIBS = $(NETWORK_LIBS)
# .....
# CXXFLAGS = -g $(ORIG_CXXFLAGS) -D_DEBUG -DXYZ_P1_PROJECT
# .....
# include @builddir@/Makefile.dll
#################################


### C/C++ source file compilation rules

CXXFLAGS_ALL = $(CXXFLAGS) $(LOCAL_CPPFLAGS) $(CPPFLAGS)
%@obj_ext@: ./%.cpp
	$(CXX) @f_compile@ $(CXXFLAGS_ALL) $< @f_outobj@$@ $(CXX_FILTER)
%@obj_ext@: $(srcdir)/%.cpp
	$(CXX) @f_compile@ $(CXXFLAGS_ALL) $< @f_outobj@$@ $(CXX_FILTER)

CFLAGS_ALL = $(CFLAGS) $(LOCAL_CPPFLAGS) $(CPPFLAGS)
%@obj_ext@: ./%.c
	$(CC) @f_compile@ $(CFLAGS_ALL) $< @f_outobj@$@ $(CC_FILTER)
%@obj_ext@: $(srcdir)/%.c
	$(CC) @f_compile@ $(CFLAGS_ALL) $< @f_outobj@$@ $(CC_FILTER)


### Library dependencies

%.dep: $(libdir)/@lib_pre@%@lib_ext@
	@touch $@


### The library build rule
XLIBOBJ     = $(LIBOBJ:=@obj_ext@)
XLOBJ       = $(LOBJ:=@obj_ext@)
XLIB        = $(LIB:%=@lib_pre@%@lib_ext@)
XDLL_LIB    = @f_libpath@$(libdir) $(DLL_LIB:%=@lib_l_pre@%@lib_l_ext@)
XDLL_LIBDEP = $(DLL_LIB:=.dep)

$(XLIB): $(XLIBOBJ) $(XDLL_LIBDEP)
	$(LINKDLL) $(XLIB) $(XLIBOBJ) $(XLOBJ) $(DLL_LIBS) $(LIBS)
	$(BINCOPY) $(XLIB) $(libdir)


### Standard targets

all: $(XLIB)

clean:
	-$(RMDIR) SunWS_cache
	-$(RM) .make.state
	-$(RM) $(XLIBOBJ)
	-$(RM) $(XLIB)
	-$(RM) *~

purge: clean
	-cd $(libdir)  &&  $(RM) $(XLIB)
