#
# $Id$
#
# Generate source and header files from protobuf spec, typically for
# use with gRPC.
#
# (NOTE: hard-wired for the C++ Toolkit directory structure.)
#

-include $(builddir)/Makefile.mk

SRCDIR = $(top_srcdir)/src/$(MODULE_PATH)
INCLUDEDIR = $(top_srcdir)/include/$(MODULE_PATH)

SPEC = $(MODULE_ASN) # sic
FILES = $(MODULE).files
IMPDIRS = $(dir $(IMPFILES))
PROTOC_FLAGS = $(IMPDIRS:%=-I%)
comma = ,
PROTO_PATH = .:$(subst $(comma),:,$(MODULE_SEARCH))

GRPC_BIN = @GRPC_BIN@
PROTOC = $(GRPC_BIN)/protoc
GRPC_CPP_PLUGIN = $(GRPC_BIN)/grpc_cpp_plugin

SED_SCRIPT = '/^\#include ".*pb.h"/ { s|"|<'$(MODULE_PATH)'/|; s/"/pp>/ }'
DEPS = $(SPEC) $(PROTOC) $(MODULE).module $(IMPDEPS)

all: sources

all_files: sources

sources: $(FILES)

clean_sources:
	-$(RM) $(FILES) *.pb.cc *.pb.h

purge_sources:
	-$(RM) $(FILES) *.pb.[ch]* $(INCLUDEDIR)/*.pb.hpp

purge_all_sources:
	-$(RM) $(FILES) *.pb.[ch]* $(INCLUDEDIR)/*.pb.hpp

purge_all_files:
	-$(RM) $(FILES) *.pb.[ch]* $(INCLUDEDIR)/*.pb.hpp

$(FILES): $(MODULE).pb.cpp      $(INCLUDEDIR)/$(MODULE).pb.hpp      \
          $(MODULE).grpc.pb.cpp $(INCLUDEDIR)/$(MODULE).grpc.pb.hpp
	@$(TOUCH) $@

$(MODULE).pb.cc $(MODULE).pb.h: $(DEPS)
	$(PROTOC) $(PROTOC_FLAGS) --cpp_out=. $(SPEC)

$(MODULE).grpc.pb.cc $(MODULE).grpc.pb.h: $(DEPS) $(GRPC_CPP_PLUGIN)
	$(PROTOC) $(PROTOC_FLAGS) --grpc_out=. --proto_path=$(PROTO_PATH) \
	    --plugin=protoc-gen-grpc=$(GRPC_CPP_PLUGIN) $(SPEC)

%.pb.cpp: %.pb.cc
	$(SED) -e $(SED_SCRIPT) $< > $@

$(INCLUDEDIR)/%.pb.hpp: %.pb.cc # not .h, to avoid duplicate protoc runs
	$(MKDIR) -p $(INCLUDEDIR)
	$(SED) -e $(SED_SCRIPT) $*.pb.h > $@

$(MODULE).module:
	@$(TOUCH) $@
