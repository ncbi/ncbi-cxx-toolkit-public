#################################
# $Id$
# Author:  Aaron Ucko (ucko@ncbi.nlm.nih.gov)
#################################
# This can be used to build/install/clean BOTH
#
# a single(sic!) library [LIB] made of object files [LIBOBJ] and [LOBJ]
# where [LIBOBJ].o will be automagically compiled from [LIBOBJ].cpp or
# [LIBOBJ].c, and [LOBJ].o must be already compiled by this time.
#
# AND
#
# a single shared(DLL) library [LIB] made of object files
# shared/[LIBOBJ] and shared/[LOBJ] where shared/[LIBOBJ].o will be
# automagically compiled from [LIBOBJ].cpp or [LIBOBJ].c, and
# shared/[LOBJ].o must be already compiled by this time.

# The following libs will be used to resolve external referencies:
#   [DLL_LIB]  -- libs located in the NCBI C++ "lib/" dir;
#   [DLL_LIBS] -- 3rd-party libs
#
################
## Example of usage:
#
# srcdir = @srcdir@
# include @builddir@/Makefile.mk
#
# LIB      = p1
# LIBOBJ   = p1_src1 p1_src2
# LOBJ     = p1_myobj
#
# DLL_LIB  = xncbi
# LIBS = $(NETWORK_LIBS)
# .....
# CXXFLAGS = -g $(ORIG_CXXFLAGS) -D_DEBUG -DXYZ_P1_PROJECT
# .....
# include @builddir@/Makefile.both
#################################

default_rule: all


### C/C++ source file compilation (and maybe auto-dependencies) build rules
# Build both shared and static libraries as PIC for the PubMed people.

#CXXFLAGS_ALL = @f_compile@ $(CXXFLAGS) $(LOCAL_CPPFLAGS) $(CPPFLAGS)
#CFLAGS_ALL   = @f_compile@ $(CFLAGS)   $(LOCAL_CPPFLAGS) $(CPPFLAGS)
CXXFLAGS_ALL = @f_compile@ \
	$(CXXFLAGS) $(CXXFLAGS_DLL) $(LOCAL_CPPFLAGS) $(CPPFLAGS)
CFLAGS_ALL   = @f_compile@ \
	$(CFLAGS) $(CFLAGS_DLL) $(LOCAL_CPPFLAGS) $(CPPFLAGS)
SOURCES      = @UNIX_SRC@ $(SRC) $(LIBOBJ)
include $(builddir)/Makefile.$(Rules)


### The static library build rule

XLIBOBJ     = $(SOURCES:=@obj_ext@)
XLOBJ       = $(LOBJ:=@obj_ext@)
XLIB        = $(LIB:%=@lib_pre@%@lib_ext@)
XLIBDEP     = .$(LIB).dep
XLIBLINK    = @lib_pre@$(LIB)-static@lib_ext@
XLIBDEPLINK = .$(LIB)-static.dep

$(XLIB): $(XLIBOBJ)
	-$(RM) $(XLIB)
	$(AR) @f_outlib@$(XLIB) `@LORDER@ $(XLIBOBJ) $(XLOBJ) | @TSORT@`
	@$(RANLIB) $(XLIB)
	$(TOUCH) -r $(XLIB) $(XLIBDEP)
	$(BINCOPY) $(XLIB) $(libdir)
	$(BINTOUCH) -r $(libdir)/$(XLIB) $(libdir)/$(XLIBDEP)
	-$(RM) $(libdir)/$(XLIBLINK) $(libdir)/$(XLIBDEPLINK)
	(cd $(libdir) && $(LN_S) $(XLIB) $(XLIBLINK))
	(cd $(libdir) && $(LN_S) $(XLIBDEP) $(XLIBDEPLINK))


### The shared library build rule

#XDLLOBJ     = $(SOURCES:%=shared/%@obj_ext@) $(LOBJ:%=shared/%@obj_ext@)
XDLLOBJ     = $(XLIBOBJ) $(XLOBJ)
XDLL        = $(LIB:%=@lib_pre@%@dll_ext@)
XDLLDEP     = .$(LIB).dep
XDLL_LIB    = $(runpath) @f_libpath@$(libdir) $(DLL_LIB:%=@lib_l_pre@%@lib_l_ext@)
XDLL_LIBDEP = $(DLL_LIB:%=$(libdir)/.%.dep)

$(XDLL): $(XDLLOBJ) $(XDLL_LIBDEP)
	-$(RM) $(XDLL)
	$(LINK_DLL) $(XDLL) $(XDLLOBJ) $(XDLL_LIB) $(LIBS)
	$(TOUCH) -r $(XDLL) $(XDLLDEP)
	$(BINCOPY) $(XDLL) $(libdir)
	$(BINTOUCH) -r $(libdir)/$(XDLL) $(libdir)/$(XDLLDEP)


### Standard targets

all: $(XLIB) $(XDLL)

clean:
	-$(RMDIR) SunWS_cache
	-$(RMDIR) ii_files
	-$(RMDIR) ti_files
	-$(RM) .make.state
	-$(RM) $(XLIBOBJ) $(XDLLOBJ)
	-$(RM) $(XLIB) $(XDLL) $(XLIBDEP) $(XDLLDEP)
	-$(RM) $(SOURCES:=.d)

purge: clean
	-$(RM) $(libdir)/$(XLIB) $(libdir)/$(XDLL) $(libdir)/$(XLIBLINK) \
		$(libdir)/$(XLIBDEP) $(libdir)/$(XDLLDEP) \
		$(libdir)/$(XLIBDEPLINK)
