<!--#set var="TITLE" value="Load-Balancing Service Mapping Daemon (LBSMD)" -->
<!--#set var="DOCROOT" value="../.." -->
<!--#include virtual="../../ssi/header.shtml" -->

<h1>Load-Balancing Service Mapping Daemon (<tt>LBSMD</tt>)</h1>

<font size=1><u><b>Note</b></u>: Due to security issues, not all links in the public version
of this file could be accessible by outside NCBI users. Unrestricted version of this document is available to
inside NCBI users at:
<a href="http://intranet.ncbi.nlm.nih.gov/ieb/ToolBox/CPP_DOC/tools/dispatcher/LBSMD.html">http://intranet.ncbi.nlm.nih.gov/ieb/ToolBox/CPP_DOC/tools/dispatcher/LBSMD.html</a>.
</font>

<h2>Contents</h2>

<ol>
<ul>
    <li> <a href="#ref_Overview">Overview</a>
    <li> <a href="#ref_Details"><tt>LBSMD</tt> in Details</a>
    <li> <a href="#ref_Example">Example of Configuration File</a>
    <li> <a href="#ref_Client">Load-Balancing Service Mapping Client (<tt>LBSMC</tt>)</a>
    <li> <a href="#ref_Penalizer">Server Penalizer</a>
</ul>
</ol>

<p><hr><p>

<a name="ref_Overview"></a><h2>Overview</h2>

In general, <tt>LBSMD</tt> should be run at NCBI site on every host that carries either public
or private servers implementing NCBI service(s) (see however discussion about
<a href="#ref_Static"><i>static</i></a> servers). The services include CGI programs or standalone servers
to access NCBI data. Each service has a name assigned to it, <tt>TaxServer</tt>
for instance. The name uniquely identifies the service, and - <u>most importantly</u> -
the protocol used for data exchange, i.e. any client connecting to service <tt>TaxServer</tt>
knows how to communicate with that service, whereas the service can be
implemented in various ways on hosts across NCBI.
That is, the service could be implemented as a standalone server on
a host <tt>X</tt>, and as a CGI program on the same or another host <tt>Y</tt>.
(Note however, that on a certain host there should <i>not</i> more than one
server of the same <a href="#ref_ServerType">type</a> for the same service.)
Moreover, the same server can implement several services, that is
services with different names. For example, one service (like
<tt>Entrez2</tt>) can accept binary data only, and another one
(say <tt>Entrez2Text</tt>) can accept data only in text format.
For the server, the distinction between those two could be in this case
made by using a <a href="#ref_ContentType">content type specifier</a>.

<p>
The goal of <tt>LBSMD</tt> is to maintain a table of all services
available at NCBI at the moment. In addition, <tt>LBSMD</tt> keeps track of
servers, which are found non-functional (dead servers), and
it is also responsible for propagating trouble reports,
obtained back from the applications about their experience with
advertized servers (e.g. an advertized server is not
technically dead, but generates sort of garbage when accessed).
Further in this document the latter kind of feedback is called a
<i>penalty</i>.

<p>
The principle of load-balancing is simple: each server, implementing
the required service, is assigned a (calculated) rate. The higher the rate
the better the chance for that the server to be chosen. Note that load-balancing
is thus almost never deterministic (see however, discussion of negative
<a href="#ref_Bonus">local bonus coefficient</a>).

<p>
It is not obviously enough that the load-balancing daemon does not calculate the rates of servers.
Its primary goal is to collect all necessary information for that.
Actual calculation of current rates of (non-<a href="#ref_Static"><i>static</i></a>) servers is based on
many parameters of the system, including the load average, the number of
CPUs and processes, etc. The rate calculation fomulas can be found in
<a href="../../lxr/source/src/connect/ncbi_lbsm.c"><b><i>connect/ncbi_lbsm.c</i></b></a>,
which is a part of <a href="../../libs/conn.html#ref_ServiceAPI">service mapping API</a>, not <tt>LBSMD</tt>.


<p><hr><p>

<a name="ref_Details"></a><h2><tt>LBSMD</tt> in Details</h2>

<tt>LBSMD</tt> is configured by means of a configuration file (default name <tt>servrc.cfg</tt>),
which is also shared with <a href="DISPD.html#ref_NCBID">NCBI CGI engine</a>, <tt>NCBID.CGI</tt>.
Each line in the file either defines a service, or is a part of the host environment,
or is an empty line (the one entirely blank or containing a
comment only). Empty lines are all ignored in the file.
Any single configuration line can be split into several physical lines by
inserting a backslash symbol (\) before the line breaks.
A comment is introduced by a hash symbol (#).

<p>
<a name="ref_HostEnvironment"></a>A configuration line of the form
<pre>
<font color="#009900">name=value</font>
</pre>
places itself in the <i>host environment</i>. The host environment can be accessed by
clients while they make the service name resolution. Often the host environment
tells the client about limitations/options, which the host has, and based on this
additional information the client can make a decision whether the server
(despite that it is implementing the service) is suitable for carrying out client's request.
For example, the host environment can give the client an idea about what are the databases
available on the host. The host environment is not interpreted or used in any way both by the daemon and
by the load-balancing algorithm, except for that <tt>name</tt> must be a valid identifier.
The <tt>value</tt> may be practically anything, even empty.
It is left solely to the client to parse the environment and to look for the information in interest.
The host environment can be obtained from the service iterator via call to
<a href="../../lxr/ident?i=SERV_GetNextInfoEx"><b><i>SERV_GetNextInfoEx()</i></b></a>,
which is documented in <a href="../../libs/conn.html#ref_ServiceAPI">service mapping API</a>.<br>
<u>Note</u>: White characters surrounding <tt>name</tt> are not preserved, but they are
preserved in <tt>value</tt>, i.e. when appear after the assignment sign.

<p>
<a name="ref_Service"></a>A <i>service</i> is defined by a line of the form
<pre>
<font color="#009900">service_name [check_time] server_descriptor [| launcher_info ]</font>
</pre>
<ul>
<li><font color="#CC33CC"><tt>service_name</tt></font> specifies the service, for instance
<tt>TaxServer</tt>.
<li><font color="#CC33CC"><tt>[check_time]</tt></font> is an optional parameter (if omitted,
the surrounding square brackets must go, too),
which specifies the number of seconds for periodic checkups.
For example, <tt>[120]</tt> means to check the server once
every 2 minutes. Note the square brackets - they are required.
<li><font color="#CC33CC"><tt>server_descriptor</tt></font> specifies address of the server and
supplies additional information, which is described in details later in this document.
An example of the <tt>server_descriptor</tt>:
<pre>
<font color="navy">STANDALONE somehost:1234 R=3000 L=yes S=yes B=-20</font>
</pre>
<li><font color="#CC33CC"><tt>launcher_info</tt></font> is basically a command line
preceded by a pipe symbol (<tt>|</tt>), delimiting from <tt>server_descriptor</tt>.
It is only required for <a href="#ref_ServerType">servers of type</a> <tt>NCBID</tt>,
which are configured on the local host.
</ul>

<p>
<tt>Server_descriptor</tt>, also detailed in
<a href="../../lxr/source/include/connect/ncbi_server_info.h"><b><i>connect/ncbi_server_info.h</i></b></a>,
consists of the following fields
<ol>
<font color="#009900"><tt>server_type [host][:port] [arguments] [flags]</tt><br></font>
where:
<ul type=square>
<li><a name="ref_ServerType"></a><font color="#009900"><tt>server_type</tt></font> is one of the following keywords (see also
  <a href="../../libs/conn.html#ref_ServerTypes">here</a>):<br>
  <ul compact type=bullet>
  <li><font color="#CC33CC"><tt>NCBID</tt></font> for servers launched by <a href="DISPD.html#ref_NCBID"><tt>ncbid.cgi</tt></a>;
  <li><font color="#CC33CC"><tt>STANDALONE</tt></font> for standalone servers listening on dedicated ports;
  <li><font color="#CC33CC"><tt>HTTP_GET</tt></font> for servers, which are the CGI programs accepting only <i>GET</i> request method;
  <li><font color="#CC33CC"><tt>HTTP_POST</tt></font> for servers, which are the CGI programs accepting only <i>POST</i> request method;
  <li><font color="#CC33CC"><tt>HTTP_POST</tt></font> for servers, which are the CGI programs accepting both of either <i>GET</i> or <i>POST</i> request methods.<br>
  <u>Note</u>: <tt>FIREWALL</tt> server specification may not be used in configuration file.
  </ul>
<li>Both <font color="#009900"><tt>host</tt></font> and <font color="#009900"><tt>port</tt></font> parameters are optional. Defaults are local host and
port 80 except for <tt>STANDALONE</tt> servers, which do <i>not</i> have a default port value.</br>
<a name="ref_Static"></a>If <tt>host</tt> <b><u>is specified</u></b> (either <tt>localhost</tt> or local host name/IP)
then the described server is not a subject for variable load-balancing, but is a so-called <i>static</i>
server. Such a server always has a constant rate, independent on the host load.
<li><font color="#009900"><tt>arguments</tt></font> are required for <tt>HTTP*</tt> servers, and must specify
local part of URL of the CGI program and optionally parameters, like:
<ol>
<font color="navy"><tt>/somepath/somecgi.cgi?param1&amp;param2=value2&amp;param3=value3</tt></font>
</ol>
If no parameters are to be supplied then the question mark (?) must be omitted, too.<br>
For <tt>NCBID</tt> servers, arguments are parameters to
pass to the server and are formed as arguments for CGI programs, i.e.
<ol>
<font color="navy"><tt>param1&amp;param2&amp;param3=value</tt></font>
</ol>
As a special rule, <font color="navy"><tt>''</tt></font> (two single quotes) may be used to denote an empty argument for <tt>NCBID</tt> server.<br>
<tt>STANDALONE</tt> servers do <i>not</i> take any <tt>arguments</tt>.
<li><font color="#009900"><tt>flags</tt></font> can come in no specific order (but no more than one instance of a flag is allowed),
and essentially are the optional modifiers of values used by default. The following flags are
recognized:
<ul type=circle>
  <li>load calculation keyword:
  <ul type=bullet>
    <li><font color="#CC33CC"><tt>Blast</tt></font> to use special algorithm for rate calculation acceptable for <a href="http://www.ncbi.nlm.nih.gov/BLAST">BLAST</a>
	applications. The algorithm uses instant values of the host load, and thus is less conservative and more
	reactive than the ordinary one;
    <li><font color="#CC33CC"><tt>Regular</tt></font> to use an ordinary rate calculation (default, and the only load calculation
    option allowed for <a href="#ref_Static"><i>static</i></a> servers).
  </ul>
  <li>base rate:
  <ul type=bullet>
  <li><font color="#CC33CC"><tt>R=value</tt></font> sets base server reachability rate (as a floating point number),
  default is 1000. Any negative value makes the server unreachable, and a value of&nbsp;0 uses the default.
  The maximal allowed base rate is 100000.
  </ul>
  <li><a name="ref_Local"></a>locality marker:
  <ul type=bullet>
     <li><font color="#CC33CC"><tt>L={yes|no}</tt></font> sets (if <tt>yes</tt>) the server to be <i>local only</i>.
     Default is <tt>no</tt>.
     <a href="../../libs/conn.html#ref_ServiceAPI">Service mapping API</a> returns <i>local only</i> servers
     in the case of mapping with the use of <tt>LBSMD</tt> running on the same - local - host (direct mapping),
     or if the dispatching (indirect mapping) occurs within the NCBI Intranet. Otherwise, if service mapping
     occurs using non-local network (certainly indirectly, via exchange with <a href="DISPD.html"><tt>dispd.cgi</tt></a>)
     then <i>local only</i> servers are not seen.
  </ul>
  <li><a name="ref_Stateful"></a>stateful server:
  <ul type=bullet>
     <li><font color="#CC33CC"><tt>S={yes|no}</tt></font> sets (if <tt>yes</tt>) that the server can only accept dedicated connections,
     and is not capable of doing <i>stateless</i> (HTTP-like) data exchange. Such a server can only be
     accessed by creating a stream connection to it, and the entire data transfer is to happen
     while the connection is alive. Default is <tt>no</tt>. This flag <i>cannot</i> be specified for <tt>HTTP*</tt> servers.<br>
     <u>Note</u>: Due to mutual incompatibility, Web-browsers <i>cannot</i> directly connect to <i>stateful</i> servers.
  </ul>
  <li><a name="ref_ContentType"></a>content type specifier:
  <ul type=bullet>
     <li><font color="#CC33CC"><tt>C=type/subtype</tt></font> specifies what is the data type that the server accepts/generates.
     There is no default value for this flag.
  </ul>
  <li><a name="ref_Bonus"></a>local bonus coefficient:
  <ul type=bullet>
     <li><font color="#CC33CC"><tt>B=value</tt></font>. The interpretation of this flag depends on the sign of <tt>value</tt>. When positive,
     <tt>value</tt> specifies a multiplier, which applies to the server rate when the server is locally run.
     When zero (default), the slight default rate increase takes effect for locally run servers. When <tt>value</tt> is negative, the
     locally run server overrides those even having higher rates and preceding the local one, but only if the local server has
     a rate, which is not in the percentile (expressed by the absolute <tt>value</tt>) of average rest rate of all other servers,
     implementing the service.<br>
     For example, a server on a <u>local</u> host <tt>Z</tt> configured with <tt>B=-5</tt> (and currently having rate of 100)
     will be chosen by the <u>local</u> load-balancer even if there were servers on hosts <tt>X</tt> and <tt>Y</tt> having rates
     1000 and 2000, because 100 is more than 5% of (1000 + 2000)/2 = 1500, which is 75.</br>
     <u>Note</u> again that for this coefficient to play, <i>both</i> server <i>and</i> mapping must be on the same host.
  </ul>
</ul>
</ul>
</ol>

<p>
The main loop of the daemon comprises of periodic checks of configuration file and reloads of the configuration if
necessary, checks and processings of incoming messages from load-balancing daemons running on
other hosts, generating and brodacasting messages to the other hosts about the load of the system and
configured services. Also, the daemon periodically checks whether the configured servers are alive, trying
to connect to them, and then to immediately disconnect, without sending/receiving any data. This way the daemon
is only able to check if the network port is working. Further server accessibility information could
be sent back to the daemon in the form of <a href="#ref_Penalizer">penalty</a> by applications,
which actually use the server.

<p>
The daemon can be configured by a dozen of switches, which modify certain
parameters from their default values. To see all command-line switches, switch <tt>-h</tt> may be used,
or NCBI Intranet users <i>only</i> can click <a href="http://pluto.nlm.nih.gov/Service/lbsmd.cgi">here</a>.
Also, daemon reacts on <tt>HUP</tt> signal to reload its configuration,
and both <tt>INT</tt> and <tt>TERM</tt> signals to gracefully quit. Despite very high stability, usually
the daemon is forcedly started from <tt>crontab</tt> each every few minutes on all production hosts to ensure
that the daemon is always running. This technique is safe, because no more than one instance of the daemon
is permitted on a certain host, and any attempt to start more than one is rejected.

<p>
<tt>LBSMD</tt> can generate output to the logfile, which can be limited in size to prevent
disk from flooding with messages. NCBI Intranet users <i>only</i>
<a href="http://pluto.nlm.nih.gov/Service/lbsmd.cgi?log">can take a look</a>
at (no more than 100) recent lines of the logfile on host <tt>pluto</tt>.
Signal <tt>USR1</tt> can be used to toggle verbosity level between less verbose (default) and
more verbose (when every warning generated is stored) modes.

<p>
Logfile size can be controlled by a <tt>-s</tt> switch. By default <tt>-s&nbsp;0</tt> is the
active flag, which means to create (if necessary) and to append messages to the logfile with
no limitation on the file size whatsoever. <tt>-s&nbsp;-1</tt> instructs indefinite appending
to the logfile, which has however to exist. Otherwise, log messages are not stored.
<tt>-s&nbsp;<i>positive_number</i></tt> restricts to create (if necessary) and to append to the logfile
until the file reaches the specified size in kilobytes. After that, the message logging is suspended,
and subsequent messages are discarded. Note that the limiting file size is only approximate,
and sometimes the logfile can grow slightly bigger. The daemon keeps track of logfiles and leaves
the final logging message either when switching from one file to another in case of the file has been
moved or removed or when the file size has reached its limit.

<p>
<hr>
<p>

<a name="ref_Example"></a><h2>Example of Configuration File</h2>

Below is an excerpt from sample configuration file, which declares some of the host environment,
advertizes one standalone stateful server, and one <tt>NCBID</tt> service, both implementing the same
service, and one local HTTP service.

<pre>
#         This is a configuration file of new NCBI service dispatcher
#
# Documentation:
# <a href="LBSMD.html">http://www.ncbi.nlm.nih.gov/IEB/ToolBox/CPP_DOC/tools/dispatcher/LBSMD.html</a>
#

# This goes to host environment (rather practical)
db_list=a.db b.db c.db
# And this does too (rather illustrative)
my_entry="some very important value as a quoted string"

# Standalone server listening on port 9999
TestService STANDALONE :9999 S=yes R=2000

# NCBID server (Note empty quotes to prevent treating of Regular as
# an argument. Also note bar (|) followed by path and parameters of the executable.)
TestService NCBID '' Regular | /home/webuser/TestService/a.out "parameter 1"

# Local HTTP service w/o checks (note [0])
LocalService [0] HTTP /LocalService.cgi?param=somevalue L=yes

# Static server - check it each 200 seconds
StaticService [200] STANDALONE localhost:8888

# Static server from another host where LBSMD may even not be running
# (no checks at all or just [0] allowed for non-local static servers)
ForeignService [0] STANDALONE foreignhost:7777 R=300

# end of configuration
</pre>

NCBI Intranet users <i>only</i> can take a look at a real configuration file on the host <tt>pluto</tt>
by clicking <a href="http://pluto.nlm.nih.gov/Service/lbsmd.cgi?cfg">here</a>.

<p><hr><p>

<a name="ref_Client"></a><h2>Load-Balancing Service Mapping Client (<tt>LBSMC</tt>)</h2>

This is a special <a href="../../lxr/source/src/connect/daemons/lbsmc.c">program</a>, which repeatedly
dumps onto the screen a table representing current contents of shared memory segment, where the daemon
collects all information about hosts and services. The client's output can be controlled by a number
of switches, full list of which may be obtained via switch <tt>-h</tt> alone, or NCBI Intranet users can click
<a href="http://pluto.nlm.nih.gov/Service/lbsmc.cgi?-h">here</a>. For example, to print only
the hosts currently running the daemon one can use the following command:
<pre>
>./lbsmc -s none 0
08/23/01 11:36:35 ================== sampson ===================================
Hostname/IPaddr Task/CPU LoadAv LoadBl   Status   StatBl n1 n2 n3 n4 n5 q1 q2 q3
iblastd            4/2     2.01   2.00   220.26     0.00  0  0  0  0  0 10 10  0
muncher        *  11/16    0.01   0.05 14414.42 15950.00  0  0  0  0  0 22 22  0
ray               29/6     2.71   3.14    75.39  2860.00  0  0  0  0  0  1  1  0
sampson           11/6     0.16   0.17  2173.91  5830.00  0  0  0  0  0  0  0  0
schroeder         60/8     0.45   0.00   285.72  8000.00  0  0  0  0  0  0  0  0
--------------------------------------------------------------------------------
* Hosts: 5/5, Svcs: 0/12/0      |      Heap: 8192, used: 1736/1776, free: 6416 *


08/23/01 11:36:35 LBSMD PID was detected as 9733
</pre>
For NCBI Intranet users <i>only</i> the following live lists are available for browsing:
<ul type=circle>
<li><a href="http://pluto.nlm.nih.gov/Service/lbsmc.cgi?-s_none_-w">Currently running hosts</a>;
<li><a href="http://pluto.nlm.nih.gov/Service/lbsmc.cgi?-h_none_-w">Currently configured services and servers</a>;
<li><a href="http://pluto.nlm.nih.gov/Service/lbsmc.cgi?-h_none_-w_-d">Currently dead servers</a>.
</ul>

<p><hr><p>

<a name="ref_Penalizer"></a><h2>Server Penalizer</h2>

There is a means for application to report problems of accessing a certain server back to
the load-balancing daemon, in the form of the penalty, a value in the range <tt>[0..100]</tt>,
showing in percents how bad the server is. The value&nbsp;0 means the server is completely okay,
while&nbsp;100 means the server (is misbehaving and) should <i>not</i> be used at all. The penalty is
not a constant value: once set it starts to decrease in time first slowly, then faster and
faster until reaches zero. This way, if a server was penalized for some reason beyond its control
but afterwards the reason has gone, then the server becomes gradually available as its penalty
(not being reset by applications again in the absence of the offending reason) goes itself to zero.

<p>
Technically, the penalty is maintained by a daemon, which has the server configured.
That is, received by a certain host, which may be different from the one where the
server was put into configuration file, the penalty first migrates to that host,
and then the daemon on that host announces that the server was penalized.</br>
<u>Note</u>: Once the daemon is restarted, the penalty information is lost.

<p>
<a href="../../libs/conn.html#ref_ServiceAPI">Service mapping API</a> has a call
<a href="../../lxr/ident?i=SERV_Penalize"><b><i>SERV_Penalize()</i></b></a>
declared in <a href="../../lxr/source/include/connect/ncbi_service.h"><b><i>connect/ncbi_service.h</i></b></a>,
which can be used to set the penalty for the last server obtained from the mapping iterator.

<p>
For script files (like ones used to start/stop servers) there is a dedicated utility program called
<a href="../../lxr/source/src/connect/daemons/lbsm_penalize.c"><tt>lbsm_penalize</tt></a>,
which sets penalty from command line. Because of intervening the load-balancing
mechanism substantially this command should be used with extreme care.

<p>
<tt>lbsm_penalize</tt> is now a part of LBSM set of tools installed on all hosts that run <tt>LBSMD</tt>.
As explained above, penalizing means making a server less favorable for choosing by load-balancing
mechanism. Because of the fact that the full penalty of&nbsp;100% makes a server unavailable for clients at all,
at the time when the server is about to shut down (restart) it is wise to increase the server penalty
to the maximal value, thus excluding the server from the service mapping. (Otherwise, the load-balancing daemon
might not immediately notice that the server is down and continue dispatching to that server.)
Usually penalty takes at most 5 seconds to propagate to all participating network hosts.
That is, before an actual server shutdown the following sequence of commands can be used:
<pre>
<font color="navy">&gt; ~ncbiduse/Service/lbsm_penalize 'Servicename STANDALONE 100 host 120'
&gt; sleep 5
&gt; <i>shutdown the server</i></font>
</pre>

The effect of the above is to set the maximal penalty&nbsp;<tt>100</tt> for the service <tt>Servicename</tt> (of type
<tt>STANDALONE</tt>) running on host <tt>host</tt> for at least <tt>120</tt> seconds - note the last numeric value.
(After&nbsp;120 seconds the normal behavior of the penalty occurs, i.e. automatical decreasing in time if not reset again
to a different value with optional hold time.) Default hold time equals&nbsp;0.
In order for penalty to be realized by all hosts of the subnet, <tt>sleep 5</tt> precedes the server shutdown.
Please note single quotes surrounding penalty specification: they are required in a command shell because
<tt>lbsm_penalize</tt> takes only one argument, the entire penalty specification.

<p>
As soon as the server is down, <tt>LBSMD</tt> detects it in the matter of several seconds
(if not instructed otherwise via configuration file) and then never dispatches to the server until it is up.

In some circumstances the following command may come handy:
<pre>
<font color="navy">&gt; ~ncbiduse/Service/lbsm_penalize 'Servicename STANDALONE 0 host'</font>
</pre> 
it resets the penalty to&nbsp;0 (no penalty) and is useful when, e.g. as for the previous example, the server is restarted
and ready in less than 120 seconds but the penalty is still held high by <tt>LBSMD</tt>.

<p>
<hr>
<table border=0 width="100%" cellspacing=0>
<tr>
<td align=left>
  <address><a href="mailto:lavr@ncbi.nlm.nih.gov">Anton Lavrentiev</a></address>
</td>
<!-- <td align=center><i>$Revision$</i></td> -->
<td align=right><i>$Date$</i></td>
</tr>
</table>

<!--#include virtual="../../ssi/footer.shtml" -->
